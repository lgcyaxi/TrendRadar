# Changelog v5.2.x

**Release Period**: 2026-01-17

## Overview

The 5.2.x series focuses on storage improvements, bug fixes, and cleanup of deprecated features.

---

## v5.2.8 - Fix Rolling Window New Title Detection (2026-01-20)

Fix duplicate notifications caused by incorrect "new title" detection in rolling window storage mode.

### Fixed
- **Same news titles appearing as "new" every day**
  - `_get_today_all_data_impl()` was missing `WHERE crawl_date = ?` filter
  - With rolling window storage, query returned news from all days in `current.db`
  - Time-only comparison (`first_crawl_time < latest_time`) failed across day boundaries
  - Now correctly filters by `crawl_date` to only return today's news

---

## v5.2.7 - Daily Tar.gz HTML Archiving (2026-01-18)

Improve HTML archiving to bundle all files per day into a single tar.gz archive.

### Changed
- **HTML archiving now creates daily tar.gz bundles**
  - Previous: Individual gzip files `01-14_08-55.html.gz`, `01-14_10-03.html.gz`, ...
  - New: Single daily archive `2026-01-14.tar.gz` containing all HTML files
  - Archive path: `output/html/archive/YYYY/YYYY-MM-DD.tar.gz`
  - Much easier to manage (~365 files/year max vs thousands)

### Fixed
- **HTML archiving not processing legacy folder structure**
  - Previous implementation only scanned `output/html/YYYY-MM-DD/` (new structure)
  - Now also scans `output/YYYY-MM-DD/` and `output/YYYY-MM-DD/html/` (legacy structure)
  - Empty legacy folders are automatically cleaned up after archiving

---

## v5.2.6 - Extension Architecture Improvement (2026-01-18)

Improve extension architecture to minimize upstream code changes.

### Fixed
- **AI analysis JSON parsing error with newlines**
  - AI responses with literal newlines in JSON values now parse correctly
  - Added `fix_json_control_chars()` to escape `\n`, `\r`, `\t` inside JSON strings
  - Eliminates "JSON 解析错误: Invalid control character" warnings

- **report_dedupe extension not being invoked**
  - `apply_transforms()` was only called in custom frequency_words path
  - Now correctly called for main flow after `prepare_report()`
  - Report deduplication now works for all notifications

### Changed
- **Refactored NotificationEnhancer to support channel takeover**
  - Added `send()` method to `NotificationEnhancer` base class
  - Extensions can now handle entire channel send process (content generation + sending)
  - Added `apply_notification_send()` to ExtensionManager
  - Moved mock mode, webhook sending, content formatting to wework_compact extension
  - Minimized upstream code changes in `dispatcher.py`

- **wework_compact extension improvements**
  - Shows `msg_type` in plugin load message: `[wework_compact] Loaded plugin v1.0.0 (enabled=True, channels=['wework'], msg_type=text)`
  - Extension now handles complete wework send flow via `send()` method
  - Supports mock mode and actual webhook sending internally

---

## v5.2.5 - WeWork Compact Extension Fix (2026-01-17)

Enable wework_compact NotificationEnhancer plugin to work properly.

### Fixed
- **wework_compact extension not being invoked**
  - Added `_apply_notification_enhancement()` method to NotificationDispatcher
  - WeWork channel now calls notification enhancement before sending
  - Plugin can now generate compact AI summaries for WeWork messages

- **wework_compact AI config access**
  - Fixed config access: model settings (API_KEY, MODEL, BASE_URL) are in `AI` config, not `AI_ANALYSIS`
  - Now correctly merges both configs for AI calls

- **API URL construction for custom providers**
  - If `base_url` already ends with `/chat/completions`, use it directly
  - Prevents double `/chat/completions` suffix when using Ollama-style endpoints

- **AI summary max_tokens too small**
  - Changed from hardcoded 200 to config's `MAX_TOKENS` (default 500)
  - Ensures AI-generated summaries have sufficient length

- **AI analysis section using wrong field names**
  - Fixed to use correct `AIAnalysisResult` fields: `core_trends`, `sentiment_controversy`, `signals`, `rss_insights`, `outlook_strategy`
  - AI analysis section now displays properly in notification output

### Added
- **Notification Mock Mode** (`advanced.notification_mock_mode`)
  - Print notification content without actually sending
  - Bypasses webhook configuration checks for local testing
  - Runs wework channel even without webhook URL configured
  - Useful for debugging wework_compact and other notification enhancers

- **Improved wework_compact output format**
  - Header: "今日热点: 共发现 {count} 条热点新闻"
  - AI-generated natural language summary paragraph
  - Bullet points listing each news item with source
  - AI analysis section appended at the end

- **Text/Markdown mode support**
  - Respects `WEWORK_MSG_TYPE` config (text or markdown)
  - Markdown mode uses proper formatting for bullet points and headers

### Changed
- Default AI config now uses custom provider for testing:
  - `provider: "custom"`
  - `base_url: "http://localhost:11434/v1/chat/completions"`
  - `model: "gpt-oss:120b"`

---

## v5.2.4 - Notification Scheduler Fix (2026-01-17)

Fix notification_scheduler platform filtering not working.

### Fixed
- **notification_scheduler platform filtering**
  - Previous logic kept all channel webhooks in config, ignoring the filter
  - Now properly removes non-enabled channel keys before adding enabled ones
  - Platforms list in schedule config now correctly limits which channels receive notifications

### Removed
- Deleted deprecated `config/extensions/html_ai_analysis.yaml`

---

## v5.2.3 - HTML Report Archiving (2026-01-17)

Add automatic HTML report archiving with gzip compression.

### Added
- **HTML Report Archiving**
  - Compress old HTML reports (older than `hot_days`) using gzip
  - Organize archived reports by year: `archive/YYYY/MM-DD_HH-MM.html.gz`
  - Clean up empty date folders after compression
  - Integrated with `run_maintenance()` cycle

### Changed
- Default `archive_retention_days` changed to `0` (forever) in config.yaml
  - This only affects archive.db cleanup, not HTML archiving
  - HTML archiving uses `hot_days` as the cutoff

---

## v5.2.2 - RUN_MODE Loop Fix & RSS Migration (2026-01-17)

Fix `RUN_MODE=loop` not working and RSS migration column name errors.

### Fixed
- **RUN_MODE Loop Support**
  - `main()` now properly checks `RUN_MODE` environment variable
  - Supports `RUN_MODE=loop` with `LOOP_INTERVAL` (default: 1800 seconds)
  - Continuous crawling mode for Docker deployment

- **RSS Migration Column Names**
  - Fixed column name mismatch: `link` → `url`, `published` → `published_at`
  - Migration script now correctly imports RSS data

---

## v5.2.1 - RollingWindowLocalBackend & Extension Cleanup (2026-01-17)

Implement missing `RollingWindowLocalBackend` class and deprecate `html_ai_analysis` extension.

### Added
- **RollingWindowLocalBackend Class**
  - Full implementation of rolling window storage
  - Hot/cold data separation with `current.db` and `archive.db`
  - Automatic maintenance with data migration and cleanup
  - SQL query optimization for large datasets

### Removed
- **html_ai_analysis Extension** (deprecated)
  - Upstream v5.2.0 added official AI analysis in report region
  - Extension functionality is now redundant
  - Removed `extensions/html_ai_analysis/` directory
  - Removed `docs/extensions/html-ai-analysis.md`

### Fixed
- Import error: `cannot import name 'RollingWindowLocalBackend'`
- Docker webpage 502 error caused by deprecated extension

---

## Migration Notes

1. **From 5.0.x to 5.2.x**
   - If using `html_ai_analysis` extension, remove it from config
   - Official AI analysis is now available via `display.regions.ai_analysis: true`
   - Run database migration if not already done: `python scripts/migrate_to_rolling_window.py --backup`

2. **Docker Users**
   - `RUN_MODE=loop` now works correctly
   - Use `LOOP_INTERVAL` to set crawl interval (default: 1800 seconds)
   - Entrypoint automatically migrates old per-date databases

## Files Changed (Major)

| File | Description |
|------|-------------|
| `trendradar/notification/dispatcher.py` | NotificationEnhancer support, mock mode |
| `trendradar/core/loader.py` | notification_mock_mode config loading |
| `extensions/wework_compact/__init__.py` | AI config access fix, URL construction fix |
| `trendradar/storage/local.py` | RollingWindowLocalBackend implementation, HTML archiving (+ legacy path support) |
| `trendradar/__main__.py` | RUN_MODE loop support, notification scheduler fix |
| `docker/entrypoint.sh` | Auto-migration and cleanup |
| `config/config.yaml` | Custom AI provider defaults, notification_mock_mode |
